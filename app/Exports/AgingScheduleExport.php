<?php

namespace App\Exports;

use Illuminate\Contracts\View\View;
use Maatwebsite\Excel\Concerns\FromView;
use Illuminate\Support\Facades\DB;
use PhpOffice\PhpSpreadsheet\Style\NumberFormat;
use Maatwebsite\Excel\Concerns\WithColumnFormatting;
use Maatwebsite\Excel\Concerns\WithEvents;
use Maatwebsite\Excel\Events\AfterSheet;
use Maatwebsite\Excel\Concerns\ShouldAutoSize;

class AgingScheduleExport implements FromView, ShouldAutoSize, WithEvents
{
    public function __construct($from_date, $to_date, $custid, $group)
    {
        $this->from_date = $from_date;
        $this->to_date = $to_date;
        $this->custid = $custid;
        $this->group = $group;
    }

    public function view(): View
    {
    	$currentMonth = date('m');
        $currentYear = date('Y');
        $month_to_date = date('Y-m-31', strtotime($this->to_date . "-1 month"));
        $to_date_awal = date('Y-m-1', strtotime($this->to_date));
        $awal_bulan_ini = date('Y-m-1');

    	if($this->custid == null || $this->custid == ''){
    		if($this->group == 'T'){
                $data = DB::select("select pen.custid, pen.custname, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen2 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen2.nosj=pena2.nosj and pen2.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen2.nosj=pena3.nosj and pen2.itemid=pena3.itemid where pen2.custid = pen.custid and pen2.lunas = 0 and pen2.hitung_bayar is null and (pen2.tanggal_do between ? and ?) and ((pen2.tanggal_jatuh_tempo between ? and ?) or pen2.tanggal_jatuh_tempo is null) group by pen2.custid), 0) + COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen3 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen3.nosj=pena2.nosj and pen3.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen3.nosj=pena3.nosj and pen3.itemid=pena3.itemid where pen3.custid = pen.custid and pen3.lunas = 1 and (pen3.tanggal_pelunasan between ? and ?) group by pen3.custid), 0) + COALESCE((select sum(pen4.sisa_bayar) as total from penagihan as pen4 where pen4.custid = pen.custid and pen4.lunas = 0 and pen4.hitung_bayar is not null and (pen4.tanggal_do between ? and ?) and pen4.tanggal_pelunasan < ? and ((pen4.tanggal_jatuh_tempo between ? and ?) or pen4.tanggal_jatuh_tempo is null) group by pen4.custid), 0) + COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen5 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen5.nosj=pena2.nosj and pen5.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen5.nosj=pena3.nosj and pen5.itemid=pena3.itemid where pen5.custid = pen.custid and pen5.lunas = 0 and pen5.hitung_bayar = 1 and (pen5.tanggal_do between ? and ?) and pen5.tanggal_pelunasan >= ? and ((pen5.tanggal_jatuh_tempo between ? and ?) or pen5.tanggal_jatuh_tempo is null) group by pen5.custid), 0) + COALESCE((select (sum(pen6.sisa_bayar)) from penagihan as pen6 where pen6.custid = pen.custid and pen6.lunas = 0 and pen6.hitung_bayar > 1 and (pen6.tanggal_do between ? and ?) and (pen6.tanggal_pelunasan between ? and ?) and ((pen6.tanggal_jatuh_tempo between ? and ?) or pen6.tanggal_jatuh_tempo is null) group by pen6.custid), 0) + COALESCE((select (sum(peld.nominal + peld.other)) from penagihan as pen7 left join pelunasan_detail as peld on peld.noinv = pen7.noinv and peld.custid = pen7.custid left join pelunasan as pel on pel.noar = peld.noar where pen7.custid = pen.custid and pen7.lunas = 0 and pen7.hitung_bayar > 1 and (pen7.tanggal_do between ? and ?) and (pel.tanggal between ? and ?) and ((pen7.tanggal_jatuh_tempo between ? and ?) or pen7.tanggal_jatuh_tempo is null) group by pen7.custid), 0) as saldo_awal, COALESCE((select count(distinct pen8.nosj) from penagihan as pen8 where pen8.custid = pen.custid and (pen8.tanggal_do between ? and ?) group by pen8.custid), 0) as jumlah_fak, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen9 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen9.nosj=pena2.nosj and pen9.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen9.nosj=pena3.nosj and pen9.itemid=pena3.itemid where pen9.custid = pen.custid and (pen9.tanggal_do between ? and ?) group by pen9.custid), 0) as nilai_fak, COALESCE((select sum(peld.nominal + peld.other) from pelunasan as pel join pelunasan_detail as peld on peld.noar = pel.noar where peld.custid = pen.custid and (pel.tanggal between ? and ?) group by peld.custid), 0) as pembayaran, (select(saldo_awal)) + (select(nilai_fak)) - (select(pembayaran)) as saldo_akhir, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen10 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen10.nosj=pena2.nosj and pen10.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen10.nosj=pena3.nosj and pen10.itemid=pena3.itemid where pen10.custid = pen.custid and pen10.lunas = 0 and pen10.hitung_bayar is null and pen10.tanggal_jatuh_tempo <= ? and pen10.tanggal_jatuh_tempo > ? - interval 2 month group by pen10.custid), 0) + COALESCE((select sum(pen11.sisa_bayar) from penagihan as pen11 where pen11.custid = pen.custid and pen11.lunas = 0 and pen11.hitung_bayar is not null and pen11.tanggal_jatuh_tempo <= ? and pen11.tanggal_jatuh_tempo > ? - interval 2 month group by pen11.custid), 0) as nol_dua_bulan, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen12 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen12.nosj=pena2.nosj and pen12.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen12.nosj=pena3.nosj and pen12.itemid=pena3.itemid where pen12.custid = pen.custid and pen12.lunas = 0 and pen12.hitung_bayar is null and pen12.tanggal_jatuh_tempo <= ? - interval 2 month and pen12.tanggal_jatuh_tempo > ? - interval 3 month group by pen12.custid), 0) + COALESCE((select sum(pen13.sisa_bayar) from penagihan as pen13 where pen13.custid = pen.custid and pen13.lunas = 0 and pen13.hitung_bayar is not null and pen13.tanggal_jatuh_tempo <= ? - interval 2 month and pen13.tanggal_jatuh_tempo > ? - interval 3 month group by pen13.custid), 0) as dua_tiga_bulan, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen14 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen14.nosj=pena2.nosj and pen14.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen14.nosj=pena3.nosj and pen14.itemid=pena3.itemid where pen14.custid = pen.custid and pen14.lunas = 0 and pen14.hitung_bayar is null and pen14.tanggal_jatuh_tempo <= ? - interval 3 month and pen14.tanggal_jatuh_tempo > ? - interval 4 month group by pen14.custid), 0) + COALESCE((select sum(pen15.sisa_bayar) from penagihan as pen15 where pen15.custid = pen.custid and pen15.lunas = 0 and pen15.hitung_bayar is not null and pen15.tanggal_jatuh_tempo <= ? - interval 3 month and pen15.tanggal_jatuh_tempo > ? - interval 4 month group by pen15.custid), 0) as tiga_empat_bulan, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen16 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen16.nosj=pena2.nosj and pen16.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen16.nosj=pena3.nosj and pen16.itemid=pena3.itemid where pen16.custid = pen.custid and pen16.lunas = 0 and pen16.hitung_bayar is null and ((pen16.tanggal_jatuh_tempo <= ? - interval 4 month and pen16.tanggal_jatuh_tempo >= ?) or pen16.tanggal_jatuh_tempo is null) group by pen16.custid), 0) + COALESCE((select sum(pen17.sisa_bayar) from penagihan as pen17 where pen17.custid = pen.custid and pen17.lunas = 0 and pen17.hitung_bayar is not null and ((pen17.tanggal_jatuh_tempo <= ? - interval 4 month and pen17.tanggal_jatuh_tempo >= ?) or pen17.tanggal_jatuh_tempo is null) group by pen17.custid), 0) as lebih_empat_bulan, COALESCE((select (sum(pen18.nominal_bayar)) from penagihan as pen18 where pen18.custid = pen.custid and pen18.lunas = 0 and pen18.tanggal_tagih_cust is not null and pen18.tanggal_jatuh_tempo is not null and pen18.tanggal_tagih_cust > pen18.tanggal_jatuh_tempo and (pen18.tanggal_do between ? and ?) group by pen18.custid), 0) as bg_mundur, (select(saldo_akhir)) as saldo from penagihan as pen where pen.custid like 'T%' and (pen.tanggal_do between ? and ?) group by pen.custid", [$this->from_date, $month_to_date, $this->from_date, $this->to_date, $to_date_awal, $this->to_date, $this->from_date, $month_to_date, $to_date_awal, $this->from_date, $this->to_date, $this->from_date, $month_to_date, $to_date_awal, $this->from_date, $this->to_date, $this->from_date, $month_to_date, $to_date_awal, $this->to_date, $this->from_date, $this->to_date, $this->from_date, $month_to_date, $to_date_awal, $this->to_date, $this->from_date, $this->to_date, $to_date_awal, $this->to_date, $to_date_awal, $this->to_date, $to_date_awal, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->from_date, $this->to_date, $this->from_date, $this->from_date, $this->to_date, $this->from_date, $this->to_date]);
            }else{
                $data = DB::select("select pen.custid, pen.custname, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen2 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen2.nosj=pena2.nosj and pen2.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen2.nosj=pena3.nosj and pen2.itemid=pena3.itemid where pen2.custid = pen.custid and pen2.lunas = 0 and pen2.hitung_bayar is null and (pen2.tanggal_do between ? and ?) and ((pen2.tanggal_jatuh_tempo between ? and ?) or pen2.tanggal_jatuh_tempo is null) group by pen2.custid), 0) + COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen3 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen3.nosj=pena2.nosj and pen3.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen3.nosj=pena3.nosj and pen3.itemid=pena3.itemid where pen3.custid = pen.custid and pen3.lunas = 1 and (pen3.tanggal_pelunasan between ? and ?) group by pen3.custid), 0) + COALESCE((select sum(pen4.sisa_bayar) as total from penagihan as pen4 where pen4.custid = pen.custid and pen4.lunas = 0 and pen4.hitung_bayar is not null and (pen4.tanggal_do between ? and ?) and pen4.tanggal_pelunasan < ? and ((pen4.tanggal_jatuh_tempo between ? and ?) or pen4.tanggal_jatuh_tempo is null) group by pen4.custid), 0) + COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen5 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen5.nosj=pena2.nosj and pen5.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen5.nosj=pena3.nosj and pen5.itemid=pena3.itemid where pen5.custid = pen.custid and pen5.lunas = 0 and pen5.hitung_bayar = 1 and (pen5.tanggal_do between ? and ?) and pen5.tanggal_pelunasan >= ? and ((pen5.tanggal_jatuh_tempo between ? and ?) or pen5.tanggal_jatuh_tempo is null) group by pen5.custid), 0) + COALESCE((select (sum(pen6.sisa_bayar)) from penagihan as pen6 where pen6.custid = pen.custid and pen6.lunas = 0 and pen6.hitung_bayar > 1 and (pen6.tanggal_do between ? and ?) and (pen6.tanggal_pelunasan between ? and ?) and ((pen6.tanggal_jatuh_tempo between ? and ?) or pen6.tanggal_jatuh_tempo is null) group by pen6.custid), 0) + COALESCE((select (sum(peld.nominal + peld.other)) from penagihan as pen7 left join pelunasan_detail as peld on peld.noinv = pen7.noinv and peld.custid = pen7.custid left join pelunasan as pel on pel.noar = peld.noar where pen7.custid = pen.custid and pen7.lunas = 0 and pen7.hitung_bayar > 1 and (pen7.tanggal_do between ? and ?) and (pel.tanggal between ? and ?) and ((pen7.tanggal_jatuh_tempo between ? and ?) or pen7.tanggal_jatuh_tempo is null) group by pen7.custid), 0) as saldo_awal, COALESCE((select count(distinct pen8.nosj) from penagihan as pen8 where pen8.custid = pen.custid and (pen8.tanggal_do between ? and ?) group by pen8.custid), 0) as jumlah_fak, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen9 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen9.nosj=pena2.nosj and pen9.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen9.nosj=pena3.nosj and pen9.itemid=pena3.itemid where pen9.custid = pen.custid and (pen9.tanggal_do between ? and ?) group by pen9.custid), 0) as nilai_fak, COALESCE((select sum(peld.nominal + peld.other) from pelunasan as pel join pelunasan_detail as peld on peld.noar = pel.noar where peld.custid = pen.custid and (pel.tanggal between ? and ?) group by peld.custid), 0) as pembayaran, (select(saldo_awal)) + (select(nilai_fak)) - (select(pembayaran)) as saldo_akhir, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen10 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen10.nosj=pena2.nosj and pen10.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen10.nosj=pena3.nosj and pen10.itemid=pena3.itemid where pen10.custid = pen.custid and pen10.lunas = 0 and pen10.hitung_bayar is null and pen10.tanggal_jatuh_tempo <= ? and pen10.tanggal_jatuh_tempo > ? - interval 2 month group by pen10.custid), 0) + COALESCE((select sum(pen11.sisa_bayar) from penagihan as pen11 where pen11.custid = pen.custid and pen11.lunas = 0 and pen11.hitung_bayar is not null and pen11.tanggal_jatuh_tempo <= ? and pen11.tanggal_jatuh_tempo > ? - interval 2 month group by pen11.custid), 0) as nol_dua_bulan, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen12 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen12.nosj=pena2.nosj and pen12.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen12.nosj=pena3.nosj and pen12.itemid=pena3.itemid where pen12.custid = pen.custid and pen12.lunas = 0 and pen12.hitung_bayar is null and pen12.tanggal_jatuh_tempo <= ? - interval 2 month and pen12.tanggal_jatuh_tempo > ? - interval 3 month group by pen12.custid), 0) + COALESCE((select sum(pen13.sisa_bayar) from penagihan as pen13 where pen13.custid = pen.custid and pen13.lunas = 0 and pen13.hitung_bayar is not null and pen13.tanggal_jatuh_tempo <= ? - interval 2 month and pen13.tanggal_jatuh_tempo > ? - interval 3 month group by pen13.custid), 0) as dua_tiga_bulan, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen14 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen14.nosj=pena2.nosj and pen14.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen14.nosj=pena3.nosj and pen14.itemid=pena3.itemid where pen14.custid = pen.custid and pen14.lunas = 0 and pen14.hitung_bayar is null and pen14.tanggal_jatuh_tempo <= ? - interval 3 month and pen14.tanggal_jatuh_tempo > ? - interval 4 month group by pen14.custid), 0) + COALESCE((select sum(pen15.sisa_bayar) from penagihan as pen15 where pen15.custid = pen.custid and pen15.lunas = 0 and pen15.hitung_bayar is not null and pen15.tanggal_jatuh_tempo <= ? - interval 3 month and pen15.tanggal_jatuh_tempo > ? - interval 4 month group by pen15.custid), 0) as tiga_empat_bulan, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen16 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen16.nosj=pena2.nosj and pen16.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen16.nosj=pena3.nosj and pen16.itemid=pena3.itemid where pen16.custid = pen.custid and pen16.lunas = 0 and pen16.hitung_bayar is null and ((pen16.tanggal_jatuh_tempo <= ? - interval 4 month and pen16.tanggal_jatuh_tempo >= ?) or pen16.tanggal_jatuh_tempo is null) group by pen16.custid), 0) + COALESCE((select sum(pen17.sisa_bayar) from penagihan as pen17 where pen17.custid = pen.custid and pen17.lunas = 0 and pen17.hitung_bayar is not null and ((pen17.tanggal_jatuh_tempo <= ? - interval 4 month and pen17.tanggal_jatuh_tempo >= ?) or pen17.tanggal_jatuh_tempo is null) group by pen17.custid), 0) as lebih_empat_bulan, COALESCE((select (sum(pen18.nominal_bayar)) from penagihan as pen18 where pen18.custid = pen.custid and pen18.lunas = 0 and pen18.tanggal_tagih_cust is not null and pen18.tanggal_jatuh_tempo is not null and pen18.tanggal_tagih_cust > pen18.tanggal_jatuh_tempo and (pen18.tanggal_do between ? and ?) group by pen18.custid), 0) as bg_mundur, (select(saldo_akhir)) as saldo from penagihan as pen where pen.custid like 'B%' and (pen.tanggal_do between ? and ?) group by pen.custid", [$this->from_date, $month_to_date, $this->from_date, $this->to_date, $to_date_awal, $this->to_date, $this->from_date, $month_to_date, $to_date_awal, $this->from_date, $this->to_date, $this->from_date, $month_to_date, $to_date_awal, $this->from_date, $this->to_date, $this->from_date, $month_to_date, $to_date_awal, $this->to_date, $this->from_date, $this->to_date, $this->from_date, $month_to_date, $to_date_awal, $this->to_date, $this->from_date, $this->to_date, $to_date_awal, $this->to_date, $to_date_awal, $this->to_date, $to_date_awal, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->from_date, $this->to_date, $this->from_date, $this->from_date, $this->to_date, $this->from_date, $this->to_date]);
            }
    	}else{
    		$data = DB::select("select pen.custid, pen.custname, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen2 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen2.nosj=pena2.nosj and pen2.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen2.nosj=pena3.nosj and pen2.itemid=pena3.itemid where pen2.custid = pen.custid and pen2.lunas = 0 and pen2.hitung_bayar is null and (pen2.tanggal_do between ? and ?) and ((pen2.tanggal_jatuh_tempo between ? and ?) or pen2.tanggal_jatuh_tempo is null) group by pen2.custid), 0) + COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen3 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen3.nosj=pena2.nosj and pen3.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen3.nosj=pena3.nosj and pen3.itemid=pena3.itemid where pen3.custid = pen.custid and pen3.lunas = 1 and (pen3.tanggal_pelunasan between ? and ?) group by pen3.custid), 0) + COALESCE((select sum(pen4.sisa_bayar) as total from penagihan as pen4 where pen4.custid = pen.custid and pen4.lunas = 0 and pen4.hitung_bayar is not null and (pen4.tanggal_do between ? and ?) and pen4.tanggal_pelunasan < ? and ((pen4.tanggal_jatuh_tempo between ? and ?) or pen4.tanggal_jatuh_tempo is null) group by pen4.custid), 0) + COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen5 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen5.nosj=pena2.nosj and pen5.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen5.nosj=pena3.nosj and pen5.itemid=pena3.itemid where pen5.custid = pen.custid and pen5.lunas = 0 and pen5.hitung_bayar = 1 and (pen5.tanggal_do between ? and ?) and pen5.tanggal_pelunasan >= ? and ((pen5.tanggal_jatuh_tempo between ? and ?) or pen5.tanggal_jatuh_tempo is null) group by pen5.custid), 0) + COALESCE((select (sum(pen6.sisa_bayar)) from penagihan as pen6 where pen6.custid = pen.custid and pen6.lunas = 0 and pen6.hitung_bayar > 1 and (pen6.tanggal_do between ? and ?) and (pen6.tanggal_pelunasan between ? and ?) and ((pen6.tanggal_jatuh_tempo between ? and ?) or pen6.tanggal_jatuh_tempo is null) group by pen6.custid), 0) + COALESCE((select (sum(peld.nominal + peld.other)) from penagihan as pen7 left join pelunasan_detail as peld on peld.noinv = pen7.noinv and peld.custid = pen7.custid left join pelunasan as pel on pel.noar = peld.noar where pen7.custid = pen.custid and pen7.lunas = 0 and pen7.hitung_bayar > 1 and (pen7.tanggal_do between ? and ?) and (pel.tanggal between ? and ?) and ((pen7.tanggal_jatuh_tempo between ? and ?) or pen7.tanggal_jatuh_tempo is null) group by pen7.custid), 0) as saldo_awal, COALESCE((select count(distinct pen8.nosj) from penagihan as pen8 where pen8.custid = pen.custid and (pen8.tanggal_do between ? and ?) group by pen8.custid), 0) as jumlah_fak, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen9 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen9.nosj=pena2.nosj and pen9.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen9.nosj=pena3.nosj and pen9.itemid=pena3.itemid where pen9.custid = pen.custid and (pen9.tanggal_do between ? and ?) group by pen9.custid), 0) as nilai_fak, COALESCE((select sum(peld.nominal + peld.other) from pelunasan as pel join pelunasan_detail as peld on peld.noar = pel.noar where peld.custid = pen.custid and (pel.tanggal between ? and ?) group by peld.custid), 0) as pembayaran, (select(saldo_awal)) + (select(nilai_fak)) - (select(pembayaran)) as saldo_akhir, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen10 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen10.nosj=pena2.nosj and pen10.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen10.nosj=pena3.nosj and pen10.itemid=pena3.itemid where pen10.custid = pen.custid and pen10.lunas = 0 and pen10.hitung_bayar is null and pen10.tanggal_jatuh_tempo <= ? and pen10.tanggal_jatuh_tempo > ? - interval 2 month group by pen10.custid), 0) + COALESCE((select sum(pen11.sisa_bayar) from penagihan as pen11 where pen11.custid = pen.custid and pen11.lunas = 0 and pen11.hitung_bayar is not null and pen11.tanggal_jatuh_tempo <= ? and pen11.tanggal_jatuh_tempo > ? - interval 2 month group by pen11.custid), 0) as nol_dua_bulan, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen12 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen12.nosj=pena2.nosj and pen12.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen12.nosj=pena3.nosj and pen12.itemid=pena3.itemid where pen12.custid = pen.custid and pen12.lunas = 0 and pen12.hitung_bayar is null and pen12.tanggal_jatuh_tempo <= ? - interval 2 month and pen12.tanggal_jatuh_tempo > ? - interval 3 month group by pen12.custid), 0) + COALESCE((select sum(pen13.sisa_bayar) from penagihan as pen13 where pen13.custid = pen.custid and pen13.lunas = 0 and pen13.hitung_bayar is not null and pen13.tanggal_jatuh_tempo <= ? - interval 2 month and pen13.tanggal_jatuh_tempo > ? - interval 3 month group by pen13.custid), 0) as dua_tiga_bulan, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen14 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen14.nosj=pena2.nosj and pen14.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen14.nosj=pena3.nosj and pen14.itemid=pena3.itemid where pen14.custid = pen.custid and pen14.lunas = 0 and pen14.hitung_bayar is null and pen14.tanggal_jatuh_tempo <= ? - interval 3 month and pen14.tanggal_jatuh_tempo > ? - interval 4 month group by pen14.custid), 0) + COALESCE((select sum(pen15.sisa_bayar) from penagihan as pen15 where pen15.custid = pen.custid and pen15.lunas = 0 and pen15.hitung_bayar is not null and pen15.tanggal_jatuh_tempo <= ? - interval 3 month and pen15.tanggal_jatuh_tempo > ? - interval 4 month group by pen15.custid), 0) as tiga_empat_bulan, COALESCE((select (coalesce(sum(pena2.sum1), 0) + coalesce(sum(pena3.sum2), 0)) from penagihan as pen16 left join (select (sum(penag.sub_amount) - sum(penag.diskon)) as sum1, penag.nosj, penag.itemid from penagihan as penag where penag.ppn = 0 group by penag.nosj) pena2 on pen16.nosj=pena2.nosj and pen16.itemid=pena2.itemid left join (select (sum(penag.sub_amount) - sum(penag.diskon)) + (10 * (sum(penag.sub_amount) - sum(penag.diskon)) / 100) as sum2, penag.nosj, penag.itemid from penagihan as penag where penag.ppn > 0 group by penag.nosj) pena3 on pen16.nosj=pena3.nosj and pen16.itemid=pena3.itemid where pen16.custid = pen.custid and pen16.lunas = 0 and pen16.hitung_bayar is null and ((pen16.tanggal_jatuh_tempo <= ? - interval 4 month and pen16.tanggal_jatuh_tempo >= ?) or pen16.tanggal_jatuh_tempo is null) group by pen16.custid), 0) + COALESCE((select sum(pen17.sisa_bayar) from penagihan as pen17 where pen17.custid = pen.custid and pen17.lunas = 0 and pen17.hitung_bayar is not null and ((pen17.tanggal_jatuh_tempo <= ? - interval 4 month and pen17.tanggal_jatuh_tempo >= ?) or pen17.tanggal_jatuh_tempo is null) group by pen17.custid), 0) as lebih_empat_bulan, COALESCE((select (sum(pen18.nominal_bayar)) from penagihan as pen18 where pen18.custid = pen.custid and pen18.lunas = 0 and pen18.tanggal_tagih_cust is not null and pen18.tanggal_jatuh_tempo is not null and pen18.tanggal_tagih_cust > pen18.tanggal_jatuh_tempo and (pen18.tanggal_do between ? and ?) group by pen18.custid), 0) as bg_mundur, (select(saldo_akhir)) as saldo from penagihan as pen where pen.custid = ? and (pen.tanggal_do between ? and ?) group by pen.custid", [$this->from_date, $month_to_date, $this->from_date, $this->to_date, $to_date_awal, $this->to_date, $this->from_date, $month_to_date, $to_date_awal, $this->from_date, $this->to_date, $this->from_date, $month_to_date, $to_date_awal, $this->from_date, $this->to_date, $this->from_date, $month_to_date, $to_date_awal, $this->to_date, $this->from_date, $this->to_date, $this->from_date, $month_to_date, $to_date_awal, $this->to_date, $this->from_date, $this->to_date, $to_date_awal, $this->to_date, $to_date_awal, $this->to_date, $to_date_awal, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->to_date, $this->from_date, $this->to_date, $this->from_date, $this->from_date, $this->to_date, $this->custid, $this->from_date, $this->to_date]);
    	}

        return view('excel_aging_schedule', [
            'data' => $data, 'from_date' => $this->from_date, 'to_date' => $this->to_date
        ]);
    }

    public function registerEvents(): array
    {
        
        $styleArray = [
        'font' => [
        'name' => 'Times New Roman',
        'size' => 14
        ]
        ];
            
        return [
            AfterSheet::class => function(AfterSheet $event) use ($styleArray)
            {
                $event->sheet->getStyle('A1')->ApplyFromArray(['font' => ['bold' => true]]);
                $event->sheet->getStyle('B1')->ApplyFromArray(['font' => ['bold' => true]]);
                $event->sheet->getStyle('A2')->ApplyFromArray(['font' => ['bold' => true]]);
                $event->sheet->getStyle('A7:O8')->ApplyFromArray(['font' => ['bold' => true]]);
                $event->sheet->getStyle('A7:O8')->applyFromArray([
                    'borders' => [
                        'allBorders' => [
                            'borderStyle' => \PhpOffice\PhpSpreadsheet\Style\Border::BORDER_THIN,
                            'color' => ['argb' => '000000'],
                        ],
                    ],
                ]);
            },
        ];
    }
}
